<!-- in this page we can find : 
    - AJAX for overview, 
    - JS for input checking -->

{% extends 'core/base.html' %}
{% block content %}
<section>
    <h4 onclick="BackCNS('content')" class="curs-pointer">< index/CNS</h4>
    <h2  class="mt-5 pl-5">Contenu du mail </h2>
    <article class="mt-5 container">
        <div class="row">
            <div class="col-8">
                <form id="form_mail_skull" action="" method='post'>
                    {% csrf_token %}
                    <div class="row">
                        {%for field in form%}
                        {% for error in field.errors %}
                        <div class="alert alert-danger">
                            <strong>{{field.label}} {{ error|escape }}</strong>
                        </div>
                        {% endfor %}
                        <div class="col-12">{{field}} </div>
                        {% endfor %}
                    </div>
                </form>
            </div>
            <div class="col-4 bg-green">
                <div class=" row d-flex justify-content-around  pre-scrollable">
                    <div>
                        <p><label class="mb-0" for="sel_animal">Variables de la catégorie Animal</label></p>
                        <select name="sel_animal" id="id_select_1">
                            <option>-- Sélectionnez une variable -- </option>
                            <option onclick=AddInMail(this.value) value="**nom animal**">nom</option>
                            <option onclick=AddInMail(this.value) value="**date de naissance**">date de naissance</option>
                            <option onclick=AddInMail(this.value) value="**race**">race</option>
                            <option onclick=AddInMail(this.value) value="**espèce**">espèce</option>
                            <option onclick=AddInMail(this.value) value="**couleur**">couleur</option>
                            <option onclick=AddInMail(this.value) value="**date d'adoption**">date d'adoption</option>
                            <option onclick=AddInMail(this.value) value="**caution**">caution</option>
                        </select>
                    </div>
                    <div>
                        <p><label class="mb-0" for="sel_owner">Variables de la catégorie Propriétaire</label></p>
                        <select name="sel_owner" id="id_select_2">
                            <option>-- Sélectionnez une variable -- </option>
                            <option onclick=AddInMail(this.value) value="**prénom prop**">prénom propriétaire</option>
                            <option onclick=AddInMail(this.value) value="**nom prop**">nom propriétaire</option>
                            <option onclick=AddInMail(this.value) value="**M./Mme**">M./Mme</option>
                            <option onclick=AddInMail(this.value) value="**tel**">téléphone</option>
                            <option onclick=AddInMail(this.value) value="**mail**">mail</option>
                            <option onclick=AddInMail(this.value) value="**nb appels**">nombre d'appels</option>
                            <option onclick=AddInMail(this.value) value="**nb mails**">nombre de mails</option>
                        </select>
                    </div>
                    <div>
                        <p><label class="mb-0" for="sel_admin">Variables de la catégorie Admin</label></p>
                        <select name="sel_admin" id="id_select_3">
                            <option>-- Sélectionnez une variable -- </option>
                            <option onclick=AddInMail(this.value) value="**id dossier**">id dossier</option>
                            <option onclick=AddInMail(this.value) value="**id puce**">id puce</option>
                            <option onclick=AddInMail(this.value) value="**id tatouage**">id tatouage</option>
                            <option onclick=AddInMail(this.value) value="**état stérilisation**">état stérilisation</option>
                            <option onclick=AddInMail(this.value) value="**date de stérilisation**">date de stérilisation</option>
                            <option onclick=AddInMail(this.value) value="**date future stérilisation**">futur date de stérilisation</option>
                        </select>
                    </div>
                </div>
                <div class="row mt-4 mb-2 d-flex justify-content-around bg-green pre-scrollable">

                    <button class="button-mail-content mt-1 mb-2" onclick='GetOverview()'>Aperçu</button>
                    <button class="button-mail-content mt-1 mb-2" onclick='submit_datas()'>Enregistrer</button>
                </div>
            </div>
        </div>
        <div class="col-1 bg-secondary"></div>
    </article>
</section>
{% load static %}
<script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
<script type="text/javascript" src='{% static "mail/js/utils.js" %}'> </script>

<script type="text/javascript">

    const fullPath = window.location.href;
    let tabFullPath = fullPath.split('/');
    let param = tabFullPath[tabFullPath.length-1];
    let anteParam = tabFullPath[tabFullPath.length-2]
    const title = document.getElementById('id_title');

    //this function adds expression in body mail when user selects an option
    let AddInMail = function (givenValue){
        // this function adds the value of a button in the mail
        let body_mail = document.getElementById('body_mail');
        const startPos = body_mail.selectionStart;
        const endPos = body_mail.selectionEnd; 
        body_mail.value = body_mail.value.substring(0, startPos)
        + givenValue
        + body_mail.value.substring(endPos, body_mail.value.length)
        body_mail.focus()
    }

    //this function takes the datas from title, object and body
    const get_data = function(){
        return {
            'title': document.getElementById('id_title').value, 
            'resume': document.getElementById('id_resume').value, 
            'full_text': document.getElementById('body_mail').value.replaceAll("\n", "\\n"), 
        }
    }

    //this function opens a new window for overview
    let OpenOverview = function(mail_id){
        //open a new window for the overview
        const width  = document.body.clientWidth;
        const height = document.body.clientHeight;
        let wanted_width = (width * 50)/100
        let wanted_height = (height * 80)/100
        let spec =  "toolbar=yes,scrollbars=yes,resizable=yes,top=100,left=200,width="
        spec += wanted_width+",height="+wanted_height
        window.open("{% url 'mail:overview'%}"+mail_id, "_blank", spec);
        window.location.href = "{% url 'mail:content'%}/"+mail_id
    }

    //this functions handles reaction to integrity problem
    const ReactProblem = function(input, issue){
        if (issue == 0){
            input.style.color = 'black';
            if (input.value.search('pb') != -1){
                console.log("--->" + input.value.search('pb'))
                newInput = input.value.replace(' (pb : Ce titre existe déjà)', '')
                console.log(newInput)
                input.value = newInput; 
            }
        }else if (issue == 1){
            input.style.color = 'red';
            input.title = "Ce titre existe déjà ";
            if (input.value.search('pb') == -1){
                input.value += ' (pb : Ce titre existe déjà)'
            }
        }
    }

    //this function verifies if this title is available in db
    const checkIntegrity = function(input){
        let value = {}
        value['title'] = input.value
        if ("{{mail.title}}" == value){
            return
        }
        let url = "{% url 'mail:content' 0 'check_integrity'%}"
        if (param != 'content'){
            url = "{% url 'mail:content' %}/" + param + "/check_integrity" 
        }
        const WhatToDo = function(issue){
            ReactProblem(input, issue)
        }
        sendDatasToServer(value, url, WhatToDo)
    }

    const GetOverview = function(){
        //this function organises overview
        //1 get datas
        let value = get_data()
        let url = "{% url 'mail:content' 0 'overview'%}"
        if (param != 'content'){
            value['mail_id']=param
            url = "{% url 'mail:content' %}/" + param + "/overview" 

        } 
        const WhatToDo = function(mail_id){
            OpenOverview(mail_id)
        }
        sendDatasToServer(value, url, WhatToDo)
    }

    // //this function sends datas to server to save them
    const submit_datas = function(){
        //check if fields are empty
        const datas = get_data()
        let canSave = true
        const keys = ['title', 'resume', 'full_text']
        const frenchKeys = ['titre', 'objet', 'message']
        for (let i in keys){
            if (datas[keys[i]].length == 0 ){
                alert('le champ '+ frenchKeys[i] +" est vide ! ")
                canSave = false; 
            }
        }
        if (title.value.search('pb') != -1){
            canSave = false
            alert("Réglez le problème de titre")
        }else{
            checkIntegrity(title)
        }
        //fields are not empty
        if (canSave){
            form = document.getElementById('form_mail_skull');
            form.setAttribute('action', "{% url 'mail:content'%}");
            if (param != 'content'){
                form.setAttribute('action', "{% url 'mail:content'%}/"+param);
            }
            form.setAttribute('method', "POST");
            form.submit()
        }
        return
    }
    {% if mail %}
        const get_field = function(){
        //returns the 3 blanks to fill
        const blanks = document.getElementsByClassName('blank')
        const content = ['{{mail.title}}', '{{mail.resume}}', '{{mail.full_text}}', ] 
        for (let i = 0 ; i < blanks.length - 1 ; i++){
            blanks[i].value = content[i]
        }
        blanks[2].innerHTML = content[2]
    }
    get_field()
    {% endif %}

    // title.addEventListener('focusout', function(){
    //     checkIntegrity(title);
    // })

</script>
{% endblock%}