{% extends 'core/base.html' %}
{% block content %}
<section>
	<h2 class="mt-5 mb-2 pl-5">Page Ajout Fiche</h2>
	<article class=" bg-blue">
		<form class="sheet" action="" method="post" enctype="multipart/form-data">
			{% csrf_token %}
			<div class="container">
				<div class="row">
					<div class="col-8 bg-yellow container">
						<div class="row">
							<div class="col-3 text-center">{{form.name.label}} <br>{{form.name}}</div>
							<div class="col-3 text-center">{{form.date_of_birth.label}}<br>{{form.date_of_birth}}</div>
							<div class="col-3 text-center">{{form.date_of_adoption.label}}<br>{{form.date_of_adoption}}</div>
							<div class="col-3 text-center">{{form.date_of_neuter.label}}<br>{{form.date_of_neuter}}</div>
						</div>
						<div class="row">
							<div class="col-8" >
								<div class="row">
									<div class="col-5 bg-primary"> {{form.species}}</div>
									<div class="col-7 bg-primary" id='inputDateZone' > {{form.is_neutered}}</div>
								</div>
							</div>
							<div class="col-4 bg-secondary text-center">
								<p>{{form.race.label}} {{form.race}}</p>
								<p>{{form.color.label}}  {{form.color}}</p>
								<p>{{form.observation.label}} {{form.observation}}</p>
							</div>
						</div>
						<div class="row">
							<div class="col-4 text-center">{{form.file.label}}<br/> {{form.file}}</div>
							<div class="col-4 text-center">{{form.tatoo.label}}<br/> {{form.tatoo}}</div>
							<div class="col-4 text-center">{{form.chip.label}}<br/> {{form.chip}}</div>
						</div>
						<div class="row">
							<div class="col-3 text-center">{{form.caution.label}}<br/> {{form.caution}}</div>
							<div class="col-3 text-center">{{form.nature_caution.label}}<br/> {{form.nature_caution}}</div>
							<div class="col-3 text-center">{{form.mail_reminder.label}}<br/> {{form.mail_reminder}}</div>
							<div class="col-3 text-center">{{form.tel_reminder.label}}<br/> {{form.tel_reminder}}</div>
						</div>
						<div class=" row d-flex new-former">
							<div class="col-1"></div>
							<div class="col-4 new-owner d-flex very-center curs-pointer" onclick="dispNewOwn()">
								Nouveau propriétaire
							</div>
							<div class="col-2"></div>

							<div class="col-4 former-owner d-flex very-center curs-pointer" onclick="CreateSelectOwners()">
								Ancien propriétaire
							</div>
							<div class="col-1"></div>

						</div>
						<div class="row owner_input d-none">
							<div class="col-4 text-center">{{form.owner_name.label}}<br/> {{form.owner_name}}</div>
							<div class="col-4 text-center">{{form.owner_surname.label}}<br/> {{form.owner_surname}}</div>
							<div class="col-4 text-center">{{form.owner_sex}}</div>
						</div>
						<div class="row owner_input d-none">
							<div class="col-1"></div>
							<div class="col-4 text-center">{{form.phone.label}}<br/> {{form.phone}}</div>
							<div class="col-4 mb-2 text-center">{{form.mail.label}}<br/> {{form.mail}}</div>
							<div class="col-3 mt-4 text-center ">
								<button class="curs-pointer bg-refresh" onclick="CleanOwnerInput(event)">retour</button>
							</div>		
						</div>
					</div>			
					<div class="col-4 bg-green">
						<div class="container">
							<div class="row">
								<div class="col-12 text-center">{{form.status}}</div>
								<div class="col-8"></div>
								<div class="col-4">
									<input id="submit" type="submit" class="btn btn-primary big-btn" value="Enregistrer"> 
									<p id='verif'></p>
								</div>
								<div class="col-12">
									{% if error %}
									<p> {{error}}</p>
									{% endif %}
								</div>
							</div>
						</div>
					</div>
				</div>			
			</div>
		</form>
	</article>
</section>
{% load static %}
<script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
<script type="text/javascript" src='{% static "sheet/js/utils.js" %}'> </script>
<script type="text/javascript">
	/* *** plan ***
	1/ User select new or former owner
	2/ 	A. new displays Ownerform
	2/ 	B. former displays select with owner in option
	3/ Client sends Ajax request to get more infos about selected owner id
	4/ Client receives info, success > display ownerform and fill it
	*/

	let is_neutered_button = document.getElementById("id_is_neutered_0")
	is_neutered_button.checked = true
	let species0_button = document.getElementById('id_species_0')
	species0_button.checked = true
	let owner_sex_button = document.getElementById("id_owner_sex_0")
	owner_sex_button.checked = true
	let divNF = document.getElementsByClassName("new-former")[0]
	let ownDivs = document.getElementsByClassName('owner_input') //div for input owner
	let divFormer = document.getElementsByClassName("former-owner")[0] //div for button Ancien Propériétaire
	let divNew = document.getElementsByClassName("new-owner")[0] //div for button Nouveau Propériétaire

	//*** auto fill with today date 
	const today = function(elem) {
		let today = new Date();
		let month = today.getMonth()+1
		if (month <= 9) {
			month = '0' + String(month)}
		let date = today.getDate()+'/'+month+'/'+today.getFullYear();
		let input = elem.nextElementSibling.nextElementSibling
		input.value = date
	}

	//create an input date for the future date of neuter
	const appearNewInput = function(){
		document.getElementById('id_is_neutered_2')
		let divDate = document.createElement("div");
		divDate.innerHTML = '{{form.futur_date_of_neuter.label}} &nbsp {{form.futur_date_of_neuter}}'
		divDate.classList.add("d-none")
		divDate.id = "divDate"
		document.getElementById('inputDateZone').appendChild(divDate);

	}
	const CreateSelectOwners = function(){
		owners = []
		{% for owner in owners%}
			owners.push({
				'name' : '{{owner}}', 'id' : '{{owner.id}}'
			})
		{% endfor%}
		const whatToDo = function(data){
			dispNewOwn()
    		fillBlank(data)
		}
		SelectOwners(owners, '{% url "sheet:add"%}', whatToDo)
	}
	const GiveStartValue = function(){
		document.getElementById("id_caution").value = 0
	}
	const getInputDate = function(){
		const allInput = document.getElementsByTagName('input')
		let allInputDate = []
		for (input of allInput){
			if (input.id.substring(0,7) == "id_date"){
				allInputDate.push(input)
			}else if (input.id == "id_date_of_neuter" && input.value == ''){
				console.log('pas de date de stérilisation')
			}
		}
		console.log(allInputDate)
		return allInputDate
	}
	//*** event 
	document.getElementById("id_is_neutered").addEventListener('click', function(e){
		if(document.getElementById('id_is_neutered_2').checked){
			document.getElementById('divDate').classList.replace('d-none', "d-flex")
		}else{
			document.getElementById('divDate').classList.replace('d-flex', "d-none")
		}
	})
	document.getElementById('submit').addEventListener('click', function(event){
		//checks data consistency
		IsNeutered = document.getElementById('id_is_neutered_0').checked
		willBeNeuterable = document.getElementById('id_is_neutered_2').checked
		aniHasCaution = document.getElementById('id_caution').value
		console.log(Number(aniHasCaution) < 1)
		if (IsNeutered){
			alert("Si l'animal est déjà stéril, ne pas l'enregistrer.")
			event.preventDefault()
		}else{
			console.log("willBeNeuterable: ", willBeNeuterable)
			if (willBeNeuterable){
				if (document.getElementById('id_futur_date_of_neuter').value == ""){
					alert("Si l'animal n'est pas encore stéril, il faut indiquer quand il le sera.")
					event.preventDefault()
					return
				}
			}
			if (aniHasCaution == "" || Number(aniHasCaution) < 1) {
				alert("Si l'animal n'est pas stéril, il faut une caution.")
				event.preventDefault()
			}
		}
	});
	const main = function(){
		GiveStartValue()
		appearNewInput()
	}
	main()
</script>
{% endblock  %}

