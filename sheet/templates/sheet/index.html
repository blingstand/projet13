{% extends 'core/base.html' %}
{% block content %}
<section>
    <h2 id="title" class="pl-5 pt-2 pb-2">Gestion Fiches ANIMAUX</h2>
    <article class="mt-3 mb-3 container scrolable-y">
        <div class="row">
            <div class="col-1"></div>
            <div class="col-4  text-left">
                <button id="display"  class="bg-tomato text-white" onclick=display()>Afficher Propriétaires</button>
            </div>
            {% for elem in button_value %}
            <div class="col-2 text-center">
                <button id="{{elem.id}}" class='crud-sheet' onclick="{{elem.function}}">{{elem.name}}</button>
            </div>
            {% endfor %}
            <div class="col-1"></div>
        </div>
        <div class="mt-3  ">
            <form id="my_form" action="" method="" name="my_form">
                {% csrf_token %} 
                <table id="anim_table" class=" d-flex">
                    <tr class=" col-12 text-center first-line">
                        <td class="col-name">&nbsp;</td>
                        {% for col in anim_cols %}
                        <td class="col-name"><strong>{{col}}</strong></td>
                        {% endfor %}
                    </tr>
                    {% for animal in animals|dictsort:"name" %}
                    <tr class=" text-center {% cycle 'row1' 'row2' %}">
                        <!-- nom sexe/espece status propriétaire num-dossier num-tatoo num-puce -->
                        <td><input type="checkbox" id='{{animal.id}}' name='checkbox' value={{animal.id}}></td>
                        <td>{{animal.name}}</a></td>
                        <td class="fitwidth">{{animal.admin_data.neuter_status}}</td>
                        <td>{{animal.str_species}}</td>
                        <td>{{animal.race}}</td>
                        <td class="fitwidth">{{animal.owner}} </td>
                        <td>{{animal.admin_data.file}}</td>

                    </tr>
                    {% endfor %}
                </table>
                <table id="owner_table" class=" d-none">
                    <tr class="col-12 text-center">
                        <td class="col-name"><strong>&nbsp;</strong></td>
                        <td class="col-name"><strong>Identifiant</strong></td>
                        <td class="col-name"><strong>Nom</strong></td>
                        <td class="col-name"><strong>Prénom</strong></td>
                        <td class="col-name"><strong>Nombre d'animaux</strong></td>
                        <td class="col-name"><strong>Caution</strong></td>
                        <td class="col-name"><strong>Tel</strong></td>
                        <td class="col-name"><strong>Mail</strong></td>
                        <td class="col-name"><strong>Nb appel</strong></td>
                        <td class="col-name"><strong>Nb mail</strong></td>
                        <td class="col-name"><strong>Historique</strong></td>
                    </tr>
                    {% for owner in owners|dictsort:"owner_surname" %}
                    <tr class="col-12 text-center {% cycle 'row1' 'row2' %}">
                        <td><input type="checkbox" id='{{owner.id}}' name='checkbox' value={{owner.id}}></td>
                        <td>{{owner.id}}</a></td>
                        <td id="id_surname_{{owner.id}}">{{owner.owner_surname}}</a></td>
                        <td id="id_name_{{owner.id}}">{{owner.owner_name}}</a></td>
                        <td id="id_nb_{{owner.id}}">{{owner.number_animal}}</a></td>
                        <td>{{owner.sum_caution}}€</td>
                        <td>{{owner.phone}}</td>
                        <td class="fitwidth"><a href = "mailto:{{owner.mail}}">{{owner.mail}}</a></td>
                        <td>{{owner.tel_reminder}}</td>
                        <td>{{owner.mail_reminder}}</td>                  
                        <td class="">
                            <a href="{% url 'sheet:contact_owner' owner.id%}">gestion des contact</a>
                        </td>                 
                    </tr>
                    {% endfor %}
                </table>
            </form>
        </div>
    </article>
</section>
<script type="text/javascript">  
    const trRow1 = Array.from(document.getElementsByClassName('row1'));
    const trRow2 = Array.from(document.getElementsByClassName('row2'));
    const allTr = trRow1.concat(trRow2)
    const form = document.getElementById('my_form');
    const displayButt = document.getElementById('display')
    const UncheckAll = function(){
        //this function unchecks all the checkbox visible and invisible
        for (tr of allTr){
            tr.children[0].firstChild.checked = false
        }
    }
    const isForAnimal = function(){
        return displayButt.textContent == "Afficher Propriétaires"
    }
    //click on line means checkbox checked
    window.onload = function(){
        if (localStorage.length != 0 ){
            localStorage.clear()
        }
    }
    const activClickEvent = function(){
        for (tr of allTr){
            tr.style.cursor = 'pointer'; 
            tr = Array.from(tr.children)
            tr.splice(0,1)
            for (child of tr){
                child.onclick = function(e){
                    let target = e.target.parentElement.children[0].firstChild;
                    console.log(e.target.tagName)
                    if (target.checked == true){
                        target.checked=false; 
                    }else{
                        target.checked=true;
                    }
                };
                child.ondblclick = function(e){
                    // this event opens alter page for animal or owner
                    targid = e.target.parentElement.children[0].firstChild.id
                    if (isForAnimal()){
                        {% for animal in animals %}
                        if (targid == "{{animal.id}}"){
                            window.location.href = "{%url 'sheet:alter' animal.id%}" 
                        }
                        {% endfor %}
                    }else{
                        {% for owner in owners %}
                        if (targid == "{{owner.id}}"){
                            window.location.href = "{%url 'sheet:alter_owner' owner.id%}"
                        }
                        {% endfor %}
                    }
                };
            }
        }
    }

    function add(){
        if (isForAnimal()){
            add_page = "{% url 'sheet:add' %}"
        }else{
            add_page = "{% url 'sheet:add_owner' %}"
        }
            window.location.href = add_page; 
    }
    function alter(){
        //check whether only 1 sheet is selected
        checkbox = document.querySelectorAll('input[type=checkbox]');
        count = 0; 
        for (i=0; i < checkbox.length; i ++){
            console.log(count)
            if (checkbox[i].checked){
                id_selected = checkbox[i].id
                count ++;}
            }
            if (count == 0){
                alert('sélectionnez une fiche à modifier !')
            }else if (count == 1){
                if (isForAnimal()){
                    {% for animal in animals %}
                    if (id_selected == "{{animal.id}}"){
                        window.location.href = "{%url 'sheet:alter' animal.id%}" 
                    }
                    {% endfor %}
                }else{
                    {% for owner in owners %}
                    if (id_selected == "{{owner.id}}"){
                        window.location.href = "{%url 'sheet:alter_owner' owner.id%}"
                    }
                    {% endfor %}
                }
            }else{
                alert("trop de fiches sélectionnées (" + count + ").")
            }

        }

    function remove(){
        const checkbox = document.querySelectorAll('input[type=checkbox]');
        let count = 0; 
        let toDelete = []
        for (i=0; i < checkbox.length; i ++){
            if (checkbox[i].checked){
                toDelete.push(checkbox[i])
                count ++;
            }
        }
        if (count == 0){
            alert('sélectionnez au moins une fiche à supprimer !')
        }else {
            ToDelete = Array.from(toDelete)
            let msg = 'Confirmez-vous la suppression de '+ count + ' éléments :'
            let name = ""
            let response = false
            if (isForAnimal()){
                let specie = ""
                for (elem of toDelete){
                    name = elem.parentElement.nextElementSibling.textContent
                    specie = elem.parentElement.nextElementSibling.nextElementSibling.nextElementSibling.textContent
                    msg = msg + "\n  >" + name + " - " + specie;
                }
                response = confirm(msg);
                if (response){
                    form.setAttribute('action', "{% url 'sheet:index' own=0%}");
                    form.setAttribute('method', "POST");
                    form.submit()
                }
            }else{
                let nb_animaux = ""
                let surname = ""
                for (elem of toDelete){
                    nb_animaux = document.getElementById('id_nb_'+elem.id).textContent
                    name = document.getElementById('id_name_'+elem.id).textContent
                    surname = document.getElementById('id_surname_'+elem.id).textContent
                    if (nb_animaux != 0){
                        alert("Ce propriétaire ("+ name +" "+surname+") est lié à au moins une fiche animal. Il ne peut être suppprimé !")
                        return
                    }
                    msg = msg + "\n  > " + name + " " + surname + " ("+nb_animaux+" animal).";
                }
                response = confirm(msg);
                if (response){
                    form.setAttribute('action', "{% url 'sheet:index' own=1%}");
                    form.setAttribute('method', "POST");
                    form.submit()
                }

            }
        }
        form.setAttribute('action', "");
    }
    const display= function(){
        //display owner and change button value
        let addBut = document.getElementById('ajouter')
        let alterBut = document.getElementById('modifier')
        let removeBut = document.getElementById('supprimer')
        let title = document.getElementById('title')
        UncheckAll()


        if (displayButt.textContent == "Afficher Propriétaires"){
            document.getElementById('anim_table').classList.replace('d-flex', 'd-none');
            document.getElementById('owner_table').classList.replace('d-none', 'd-flex');
            displayButt.innerHTML = "Afficher Animaux"
            addBut.innerHTML = "Ajouter "  
            alterBut.innerHTML = "Modifier "  
            removeBut.innerHTML = "Supprimer "  
            displayButt.id="display2"
            title.innerHTML="Gestion Fiches PROPRIETAIRES"
            // addBut.classList.replace('crud-sheet', 'crud-sheet2') 
            // alterBut.classList.replace("crud-sheet", "crud-sheet2")  
            // removeBut.classList.replace("crud-sheet", "crud-sheet2")   
        }else{
            document.getElementById('owner_table').classList.replace('d-flex', 'd-none');
            document.getElementById('anim_table').classList.replace('d-none', 'd-flex');
            displayButt.textContent = "Afficher Propriétaires"
            addBut.innerHTML = "Ajouter"  
            alterBut.innerHTML = "Modifier"  
            removeBut.innerHTML = "Supprimer"
            displayButt.id="display"
            title.innerHTML="Gestion Fiches ANIMAUX"
            // addBut.classList.replace('crud-sheet2', 'crud-sheet') 
            // alterBut.classList.replace("crud-sheet2", "crud-sheet")  
            // removeBut.classList.replace("crud-sheet2", "crud-sheet")   
            
        }
    }
    const displayOwner = function(){
        let dispOwn = ({{disp_owners}} == 1)
        if (dispOwn){
            display()
        }
    }
    const main = function(){
        activClickEvent()
        displayOwner()
    }
    main()
</script>
{% endblock  %}

