{% extends 'spa_core/base.html' %} 
{% block content %}
<h2 id="title" class="">Gestion Fiches ANIMAUX </h2>
<article class="art-sheet-index">
    <div class="container-button">
        <div class="container-button-toggle">
            <button id="display"  class="bg-tomato text-white" onclick=display()>Afficher Propriétaires</button>
        </div>
        <div class="container-button-cud">
            {% for elem in button_value %}
            <button id="{{elem.id}}" class='crud-sheet' onclick="{{elem.function}}">{{elem.name}}</button>
            {% endfor %}
        </div>
    </div>
    <form id="my_form" action="" method="" name="my_form">
        {% csrf_token %} 
        <div id="anim_table" class="table d-block ">
            
            <div class="row-title">
                {% for top_column in top_columns_anim %}
                <div class="col-name"><strong>{{top_column | safe}}</strong></div>
                {% endfor %}
            </div>
            <div class="scrollable-part">
                {% for animal in animals|dictsort:"name" %}
                <div class=" {% cycle 'row1' 'row2' %}">
                    <!-- nom sexe/espece status propriétaire num-dossier num-tatoo num-puce -->
                    <div class="container-checkbox"><input type="checkbox" id='{{animal.id}}' name='checkbox' value={{animal.id}}></div>
                    <div>{{animal.name}}</a></div>
                    <div>{{animal.admin_data.neuter_status}}</div>
                    <div>{{animal.str_species}}</div>
                    <div>{{animal.race}}</div>
                    <div>{{animal.owner}} </div>
                    <div>{{animal.admin_data.file}}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div id="owner_table" class="d-none">
            <div class="">
                {% for top_column in top_columns_owner%}
                <div class="col-name"><strong>{{top_column}}</strong></div>
                {% endfor%}
            </div>
            {% for owner in owners|dictsort:"owner_surname" %}
            <div class=" {% cycle 'row1' 'row2' %}">
                <div class="container-checkbox">
                    <input type="checkbox" id='ow{{owner.id}}' name='checkbox' value={{owner.id}}></div>
                <div>{{owner.id}}</a></div>
                <div id="id_surname_{{owner.id}}">{{owner.owner_surname}}</a></div>
                <div id="id_name_{{owner.id}}">{{owner.owner_name}}</a></div>
                <div id="id_nb_{{owner.id}}">{{owner.number_animal}}</a></div>
                <div>{{owner.sum_caution}}€</div>
                <div>{{owner.phone}}</div>
                <div class="bigger"><a href = "mailto:{{owner.mail}}">{{owner.mail}}</a></div>
                <div>{{owner.tel_reminder}}</div>
                <div>{{owner.mail_reminder}}</div>                  
                <div class="">
                    <a id="id_contact_{{owner.id}}" href="{% url 'sheet:contact_owner' owner.id%}">gestion des contacts</a>
                </div>                 
            </div>
            {% endfor %}
        </div>
    </form>
</article>

<script type="text/javascript">  
    const trRow1 = Array.from(document.getElementsByClassName('row1'));
    const trRow2 = Array.from(document.getElementsByClassName('row2'));
    const allTr = trRow1.concat(trRow2)
    const form = document.getElementById('my_form');
    const displayButt = document.getElementById('display')
    const UncheckAll = function(){
        //this function unchecks all the checkbox visible and invisible
        for (tr of allTr){
            tr.children[0].firstChild.checked = false
        }
    }
    const isForAnimal = function(){
        return displayButt.textContent == "Afficher Propriétaires"
    }
    //click on line means checkbox checked
    window.onload = function(){
        if (localStorage.length != 0 ){
            localStorage.clear()
        }
    }
    const activClickEvent = function(){
        for (tr of allTr){
            tr.style.cursor = 'pointer'; 
            tr = Array.from(tr.children)
            tr.splice(0,1)
            for (child of tr){
                child.onclick = function(e){
                    let target = e.target.parentElement.children[0].firstChild;
                    console.log(e.target.tagName)
                    if (target.checked == true){
                        target.checked=false; 
                    }else{
                        target.checked=true;
                    }
                };
                child.ondblclick = function(e){
                    // this event opens alter page for animal or owner
                    targid = e.target.parentElement.children[0].firstChild.id
                    if (isForAnimal()){
                        {% for animal in animals %}
                        if (targid == "{{animal.id}}"){
                            window.location.href = "{%url 'sheet:alter' animal.id%}" 
                        }
                        {% endfor %}
                    }else{
                        {% for owner in owners %}
                        if (targid == "{{owner.id}}"){
                            window.location.href = "{%url 'sheet:alter_owner' owner.id%}"
                        }
                        {% endfor %}
                    }
                };
            }
        }
    }

    function add(){
        if (isForAnimal()){
            add_page = "{% url 'sheet:add' %}"
        }else{
            add_page = "{% url 'sheet:add_owner' %}"
        }
        window.location.href = add_page; 
    }
    function alter(){
        //check whether only 1 sheet is selected
        checkbox = document.querySelectorAll('input[type=checkbox]');
        count = 0; 
        for (i=0; i < checkbox.length; i ++){
            console.log(count)
            if (checkbox[i].checked){
                id_selected = checkbox[i].id
                count ++;}
            }
            if (count == 0){
                alert('sélectionnez une fiche à modifier !')
            }else if (count == 1){
                if (isForAnimal()){
                    {% for animal in animals %}
                    if (id_selected == "{{animal.id}}"){
                        window.location.href = "{%url 'sheet:alter' animal.id%}" 
                    }
                    {% endfor %}
                }else{
                    {% for owner in owners %}
                    if (id_selected == "ow{{owner.id}}"){
                        window.location.href = "{%url 'sheet:alter_owner' owner.id%}"
                    }
                    {% endfor %}
                }
            }else{
                alert("trop de fiches sélectionnées (" + count + ").")
            }

        }

        function remove(){
            const checkbox = document.querySelectorAll('input[type=checkbox]');
            let count = 0; 
            let toDelete = []
            for (i=0; i < checkbox.length; i ++){
                if (checkbox[i].checked){
                    toDelete.push(checkbox[i])
                    count ++;
                }
            }
            if (count == 0){
                alert('sélectionnez au moins une fiche à supprimer !')
            }else {
                ToDelete = Array.from(toDelete)
                let msg = 'Confirmez-vous la suppression de '+ count + ' éléments :'
                let name = ""
                let response = false
                if (isForAnimal()){
                    let specie = ""
                    for (elem of toDelete){
                        name = elem.parentElement.nextElementSibling.textContent
                        specie = elem.parentElement.nextElementSibling.nextElementSibling.nextElementSibling.textContent
                        msg = msg + "\n  >" + name + " - " + specie;
                    }
                    response = confirm(msg);
                    if (response){
                        form.setAttribute('action', "{% url 'sheet:index' own=0%}");
                        form.setAttribute('method', "POST");
                        form.submit()
                    }
                }else{
                    let nb_animaux = ""
                    let surname = ""
                    for (elem of toDelete){
                        nb_animaux = document.getElementById('id_nb_'+elem.id).textContent
                        name = document.getElementById('id_name_'+elem.id).textContent
                        surname = document.getElementById('id_surname_'+elem.id).textContent
                        if (nb_animaux != 0){
                            alert("Ce propriétaire ("+ name +" "+surname+") est lié à au moins une fiche animal. Il ne peut être suppprimé !")
                            return
                        }
                        msg = msg + "\n  > " + name + " " + surname + " ("+nb_animaux+" animal).";
                    }
                    response = confirm(msg);
                    if (response){
                        form.setAttribute('action', "{% url 'sheet:index' own=1%}");
                        form.setAttribute('method', "POST");
                        form.submit()
                    }

                }
            }
            form.setAttribute('action', "");
        }
        const display= function(){
        //display owner and change button value
        let addBut = document.getElementById('ajouter')
        let alterBut = document.getElementById('modifier')
        let removeBut = document.getElementById('supprimer')
        let title = document.getElementById('title')
        UncheckAll()


        if (displayButt.textContent == "Afficher Propriétaires"){
            document.getElementById('anim_table').classList.replace('d-flex', 'd-none');
            document.getElementById('owner_table').classList.replace('d-none', 'd-flex');
            displayButt.innerHTML = "Afficher Animaux"
            addBut.innerHTML = "Ajouter "  
            alterBut.innerHTML = "Modifier "  
            removeBut.innerHTML = "Supprimer "  
            displayButt.id="display2"
            title.innerHTML="Gestion Fiches PROPRIETAIRES"
            // addBut.classList.replace('crud-sheet', 'crud-sheet2') 
            // alterBut.classList.replace("crud-sheet", "crud-sheet2")  
            // removeBut.classList.replace("crud-sheet", "crud-sheet2")   
        }else{
            document.getElementById('owner_table').classList.replace('d-flex', 'd-none');
            document.getElementById('anim_table').classList.replace('d-none', 'd-flex');
            displayButt.textContent = "Afficher Propriétaires"
            addBut.innerHTML = "Ajouter"  
            alterBut.innerHTML = "Modifier"  
            removeBut.innerHTML = "Supprimer"
            displayButt.id="display"
            title.innerHTML="Gestion Fiches ANIMAUX"
            // addBut.classList.replace('crud-sheet2', 'crud-sheet') 
            // alterBut.classList.replace("crud-sheet2", "crud-sheet")  
            // removeBut.classList.replace("crud-sheet2", "crud-sheet")   
            
        }
    }
    const displayOwner = function(){
        let dispOwn = ({{disp_owners}} == 1)
        if (dispOwn){
            display()
        }
    }
    const main = function(){
        activClickEvent()
        displayOwner()
    }
    main()
</script>
{% endblock  %}

